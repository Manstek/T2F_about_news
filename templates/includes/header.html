<header>
    <div class="logo">T2F about News</div>
    <nav class="nav-links">
        <a href="{% url 'main' %}">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="{% url 'news' %}">–ù–æ–≤–æ—Å—Ç–∏</a>
        <a href="{% url 'posts' %}">–ü–æ—Å—Ç—ã</a>
        <a href="{% url 'tag_list' %}">–¢–µ–≥–∏</a>
    </nav>  

    <div class="profile-menu">
        <button class="profile-btn" id="profileBtn">
            <div class="profile-avatar" id="userAvatar">–ò–ò</div>
            <span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </button>
        
        <div class="dropdown" id="profileDropdown">
            <div class="dropdown-item">
                <i class="icon">üë§</i>
                <span>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</span>
            </div>
            <div class="dropdown-item">
                <i class="icon">‚öôÔ∏è</i>
                <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
            </div>
            <div class="dropdown-item" id="changeAvatarBtn">
                <i class="icon">üñºÔ∏è</i>
                <span>–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</span>
            </div>
            <div class="dropdown-item" id="changePasswordBtn">
                <i class="icon">üîí</i>
                <span>–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" id="logoutBtn">
                <i class="icon">üö™</i>
                <span>–í—ã–π—Ç–∏</span>
            </div>
        </div>
    </div>

    <!-- Popup –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ -->
    <div class="avatar-popup" id="avatarPopup">
        <div class="avatar-popup-content">
            <div class="avatar-preview" id="avatarPreview">
                <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ç–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª—ã -->
            </div>
            <div class="avatar-actions">
                <label for="avatarUpload" class="avatar-btn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</label>
                <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                <button class="avatar-btn delete-btn" id="deleteAvatarBtn">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="avatar-btn cancel-btn" id="cancelAvatarBtn">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
</header>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/auth/signin/';
            return;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            try {
                const response = await fetch('/api/users/me/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) return null;
                return await response.json();
            } catch {
                return null;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUserProfile(userData) {
            const userNameElement = document.getElementById('userName');
            const avatarElement = document.getElementById('userAvatar');
            
            if (userData?.first_name && userData?.last_name) {
                userNameElement.textContent = `${userData.first_name} ${userData.last_name}`;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏
                if (userData.avatar) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å URL –∞–≤–∞—Ç–∞—Ä–∫–∏ - –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    avatarElement.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = userData.avatar;
                    img.alt = '–ê–≤–∞—Ç–∞—Ä';
                    img.onerror = () => {
                        // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã
                        avatarElement.textContent = userData.first_name[0] + userData.last_name[0];
                        avatarElement.style.display = 'flex';
                    };
                    avatarElement.appendChild(img);
                    avatarElement.style.display = 'block';
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã
                    avatarElement.textContent = userData.first_name[0] + userData.last_name[0];
                    avatarElement.style.display = 'flex';
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é
        function initDropdownMenu() {
            const profileBtn = document.getElementById('profileBtn');
            const dropdown = document.getElementById('profileDropdown');
            
            if (!profileBtn || !dropdown) return;
            
            // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            const newProfileBtn = profileBtn.cloneNode(true);
            const newDropdown = dropdown.cloneNode(true);
            
            profileBtn.replaceWith(newProfileBtn);
            dropdown.replaceWith(newDropdown);
            
            // –ù–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            document.getElementById('profileBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('profileDropdown').classList.toggle('show');
            });
            
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('profileDropdown');
                const profileBtn = document.getElementById('profileBtn');
                
                if (!dropdown.contains(e.target) && e.target !== profileBtn && !profileBtn.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
        function initLogout() {
            document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_profile');
                window.location.href = '/auth/signin/';
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
        function initChangePassword() {
            document.getElementById('changePasswordBtn')?.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = '/password_change/';
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è popup –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞
        function initAvatarPopup() {
            const changeAvatarBtn = document.getElementById('changeAvatarBtn');
            const avatarPopup = document.getElementById('avatarPopup');
            const cancelAvatarBtn = document.getElementById('cancelAvatarBtn');
            const deleteAvatarBtn = document.getElementById('deleteAvatarBtn');
            const avatarUpload = document.getElementById('avatarUpload');
            const avatarPreview = document.getElementById('avatarPreview');
            
            if (!changeAvatarBtn || !avatarPopup) return;
            
            // –û—Ç–∫—Ä—ã—Ç–∏–µ popup
            changeAvatarBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                document.getElementById('profileDropdown').classList.remove('show');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userData = await loadUserData();
                if (userData) {
                    updateAvatarPreview(userData);
                }
                
                avatarPopup.classList.add('show');
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ popup
            cancelAvatarBtn.addEventListener('click', () => {
                avatarPopup.classList.remove('show');
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞
            deleteAvatarBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/users/me/avatar/', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        }
                    });
                    
                    if (response.ok) {
                        const userData = await loadUserData();
                        updateUserProfile(userData);
                        updateAvatarPreview(userData);
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞
            avatarUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const formData = new FormData();
                    formData.append('avatar', file);
                    
                    const response = await fetch('/api/users/me/avatar/', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const userData = await loadUserData();
                        updateUserProfile(userData);
                        updateAvatarPreview(userData);
                    } else {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ preview –≤ popup
            function updateAvatarPreview(userData) {
                avatarPreview.innerHTML = '';
                
                if (userData?.avatar) {
                    const img = document.createElement('img');
                    img.src = userData.avatar;
                    img.alt = '–ê–≤–∞—Ç–∞—Ä';
                    img.onerror = () => {
                        showInitials(userData);
                    };
                    avatarPreview.appendChild(img);
                } else {
                    showInitials(userData);
                }
            }
            
            function showInitials(userData) {
                if (userData?.first_name && userData?.last_name) {
                    avatarPreview.textContent = userData.first_name[0] + userData.last_name[0];
                } else {
                    avatarPreview.textContent = '??';
                }
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ popup –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            avatarPopup.addEventListener('click', (e) => {
                if (e.target === avatarPopup) {
                    avatarPopup.classList.remove('show');
                }
            });
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        try {
            initDropdownMenu();
            const userData = await loadUserData();
            
            if (userData) {
                updateUserProfile(userData);
                localStorage.setItem('user_profile', JSON.stringify(userData));
            }
            
            initLogout();
            initChangePassword();
            initAvatarPopup();
        } catch {
            document.getElementById('userName').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }
    });
</script>
