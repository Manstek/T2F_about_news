{% extends "base.html" %}
{% load static %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/news.css' %}">
    <link rel="stylesheet" href="{% static 'css/post.css' %}">
{% endblock %}
{% block content %}
    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
    <main>
        <h1 class="page-title">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</h1>

        <div class="content-grid">
            <div class="posts-container">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –ø–æ—Å—Ç–∞–º–∏ -->
                <div class="posts-card">
                    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã</h3>
                    <div class="posts-list" id="posts-list">
                        <!-- –ü–æ—Å—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="new-post-card">
                    <h3>–ù–æ–≤—ã–π –ø–æ—Å—Ç</h3>
                    <form id="new-post-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <input type="text" class="new-post-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞" required>
                        </div>
                        <div class="form-group">
                            <textarea class="new-post-textarea" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="post-image" class="file-upload-label">
                                <span>–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                                <input type="file" id="post-image" accept="image/*" class="file-upload-input">
                                <div class="image-preview" id="image-preview"></div>
                            </label>
                        </div>
                        <button type="submit" class="new-post-btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                    </form>
                </div>
                
                <div class="news-card">
                    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏</h3>
                    <div id="news-list">
                        <!-- –ù–æ–≤–æ—Å—Ç–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock content %}

{% block extra_js %}
    <script>
        /**
         * –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Å—Ç–∞–º–∏ –∏ –Ω–æ–≤–æ—Å—Ç—è–º–∏
         */
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const POSTS_LIMIT = 5;
        const NEWS_LIMIT = 10;
        const API_URL = '/api/posts/';
        const NEWS_API_URL = '/api/news/short/';
        const MAX_IMAGE_SIZE = 5 * 1024 * 1024; // 5MB
        
        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
         */
        document.addEventListener('DOMContentLoaded', async () => {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!localStorage.getItem('access_token')) {
                window.location.href = '/auth/signin/';
                return;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            await renderPosts();
            await renderNews();
            setupEventListeners();
        });
        
        /**
         * –ü–æ–∫–∞–∑–∞—Ç—å toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
         */
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        /**
         * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –ø–æ—Å—Ç–æ–≤
         */
        async function renderPosts() {
            try {
                const postsList = document.getElementById('posts-list');
                showLoadingState(postsList);
                
                const postsData = await fetchPosts();
                const posts = postsData.results || [];
                
                if (posts.length === 0) {
                    showEmptyState(postsList);
                    return;
                }
                
                postsList.innerHTML = '';
                posts.forEach(post => {
                    postsList.appendChild(createPostElement(post));
                });
                
            } catch (error) {
                const postsList = document.getElementById('posts-list');
                showErrorState(postsList, error);
            }
        }
        
        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
         */
        async function fetchPosts() {
            const response = await fetch(`${API_URL}?limit=${POSTS_LIMIT}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return await response.json();
        }

        /**
        * –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ—Å—Ç–∞ —Å –∫—Ä—É–≥–ª—ã–º –∞–≤–∞—Ç–∞—Ä–æ–º
        */
        function createPostElement(post) {
            const element = document.createElement('div');
            element.className = 'post-card';
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∞
            const authorName = post.author?.first_name && post.author?.last_name 
                ? `${post.author.first_name} ${post.author.last_name}`
                : post.author?.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä';
                
            const authorAvatar = post.author?.avatar || '';
            const authorInitials = getInitials(authorName);
            
            element.innerHTML = `
                <div class="post-header" onclick="window.location.href='/posts/${post.id}/'">
                    <div class="post-avatar">
                        ${authorAvatar 
                            ? `<img src="${escapeUrl(authorAvatar)}" alt="–ê–≤–∞—Ç–∞—Ä" style="
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                            " onerror="this.parentNode.textContent='${authorInitials}'">`
                            : authorInitials}
                    </div>
                    <div>
                        <div class="post-author">${escapeHtml(authorName)}</div>
                        <div class="post-date">${formatDate(post.pub_date)}</div>
                    </div>
                </div>
                <div class="post-content" onclick="window.location.href='/posts/${post.id}/'">
                    <h3>${escapeHtml(post.title)}</h3>
                    <p>${escapeHtml(post.text)}</p>
                    ${post.image ? `<img src="${escapeUrl(post.image)}" alt="–ü–æ—Å—Ç" class="post-image">` : ''}
                </div>
                <div class="post-actions">
                    <button class="post-action comment-btn" data-post-id="${post.id}">
                        üí¨ ${post.comments_count || 0}
                    </button>
                </div>
            `;
            return element;
        }
        
        /**
        * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π
        */
        async function renderNews() {
            try {
                const newsList = document.getElementById('news-list');
                newsList.innerHTML = '<div class="loading-spinner"></div>';
                
                const news = await fetchNews();
                
                if (news.length === 0) {
                    newsList.innerHTML = '<p class="empty-message">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                    return;
                }
                
                let newsHTML = '';
                news.forEach(item => {
                    newsHTML += `
                        <div class="news-item" data-news-id="${item.id}" onclick="window.location.href='/news/${item.id}/'">
                            <div class="news-title">
                                ${escapeHtml(item.text)}
                            </div>
                            ${item.tag ? `<div class="news-tag-container"><span class="news-tag">${escapeHtml(item.tag)}</span></div>` : ''}
                            <div class="news-date">${formatDate(item.pub_date)}</div>
                        </div>
                    `;
                });
                
                newsList.innerHTML = newsHTML;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:', error);
                const newsList = document.getElementById('news-list');
                newsList.innerHTML = `
                    <div class="error-message">
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏</p>
                        <button class="retry-btn" onclick="renderNews()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                    </div>
                `;
            }
        }
        
        /**
         * –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π —Å —Å–µ—Ä–≤–µ—Ä–∞
         */
        async function fetchNews() {
            const response = await fetch(`${NEWS_API_URL}?limit=${NEWS_LIMIT}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            return data || [];
        }
        
        /**
         * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
         */
        function setupEventListeners() {
            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
            const postForm = document.getElementById('new-post-form');
            if (postForm) {
                postForm.addEventListener('submit', createNewPost);
            }
            
            // –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            setupImagePreview();
        }
        
        /**
         * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
         */
        function setupImagePreview() {
            const fileInput = document.getElementById('post-image');
            const previewContainer = document.getElementById('image-preview');
            
            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
                    if (!file.type.match('image.*')) {
                        showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                        this.value = '';
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
                    if (file.size > MAX_IMAGE_SIZE) {
                        showToast('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–µ–Ω—å—à–µ 5MB', 'error');
                        this.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        previewContainer.innerHTML = `<img src="${e.target.result}" alt="–ü—Ä–µ–≤—å—é">`;
                        previewContainer.style.display = 'block';
                    }
                    
                    reader.readAsDataURL(file);
                } else {
                    previewContainer.innerHTML = '';
                    previewContainer.style.display = 'none';
                }
            });
        }
        
        /**
         * –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
         */
        async function createNewPost(event) {
            event.preventDefault();
            
            const titleInput = document.querySelector('.new-post-title');
            const textarea = document.querySelector('.new-post-textarea');
            const fileInput = document.getElementById('post-image');
            const submitBtn = document.querySelector('.new-post-btn');
            
            const title = titleInput.value.trim();
            const content = textarea.value.trim();
            const imageFile = fileInput.files[0];
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!title || !content) {
                showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞', 'error');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '–ü—É–±–ª–∏–∫–∞—Ü–∏—è...';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userResponse = await fetch('/api/users/me/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });
                
                if (!userResponse.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
                
                const userData = await userResponse.json();
                
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const formData = new FormData();
                formData.append('title', title);
                formData.append('text', content);
                formData.append('author', userData.id);  // –î–æ–±–∞–≤–ª—è–µ–º ID –∞–≤—Ç–æ—Ä–∞
                
                if (imageFile) {
                    formData.append('image', imageFile);
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || JSON.stringify(errorData));
                }
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                titleInput.value = '';
                textarea.value = '';
                fileInput.value = '';
                document.getElementById('image-preview').innerHTML = '';
                document.getElementById('image-preview').style.display = 'none';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤
                await renderPosts();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                showToast('–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showToast(error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç', 'error');
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        }
        
        /**
         * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
         */
        
        function showLoadingState(container) {
            container.innerHTML = '<div class="loading-spinner"></div>';
        }
        
        function showEmptyState(container) {
            container.innerHTML = '<p class="empty-message">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤</p>';
        }
        
        function showErrorState(container, error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:', error);
            container.innerHTML = `
                <div class="error-message">
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å—Ç—ã</p>
                    <button class="retry-btn">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                </div>
            `;
            container.querySelector('.retry-btn').addEventListener('click', renderPosts);
        }
        
        function formatDate(dateString) {
            const postDate = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const isSameDay = (date1, date2) => {
                return date1.getFullYear() === date2.getFullYear() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getDate() === date2.getDate();
            };
            
            if (isSameDay(postDate, today)) {
                return `—Å–µ–≥–æ–¥–Ω—è –≤ ${postDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}`;
            } else if (isSameDay(postDate, yesterday)) {
                return `–≤—á–µ—Ä–∞ –≤ ${postDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}`;
            } else {
                const options = { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return postDate.toLocaleDateString('ru-RU', options);
            }
        }
        
        function getInitials(name) {
            if (!name) return '';
            return name.split(' ')
                      .filter(part => part.length > 0)
                      .map(part => part[0].toUpperCase())
                      .join('');
        }
        
        function escapeHtml(unsafe) {
            return unsafe?.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;") || '';
        }
        
        function escapeUrl(unsafe) {
            return encodeURI(unsafe?.toString() || '');
        }
    </script>
{% endblock extra_js %}